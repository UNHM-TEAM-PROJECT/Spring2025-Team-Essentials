<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NECHE Compliance Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --unh-blue: #003591;
            --unh-white: #ffffff;
            --chat-bg: rgba(248, 249, 250, 0.95);
            --message-bg: rgba(233, 236, 239, 0.9);
            --input-bg: rgba(248, 249, 250, 0.95);
            --btn-color: #ebf0f9;
            --btn-hover: #9662be;
            --btn-text: #ffffff;
            --border-radius: 0;
            --unh-black: #403a3a;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            background-image: url('../templates/chatbot-bg.png');
            background-size: 600px;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
        }

        .page-container {
            height: 100vh;
            width: 100vw;
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--unh-blue) 0%, #003591 100%);
            color: var(--unh-white);
            padding: 1rem;
            display: flex;
            justify-content: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            height: 80px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: transparent;
        }

        .message {
            position: relative;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 1rem;
            max-width: 75%;
            animation: fadeIn 0.3s ease-in-out;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
            text-align: left;
        }

        .assistant-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            backdrop-filter: blur(5px);
            text-align: left;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            position: absolute;
            bottom: -16px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .user-message .message-avatar {
            right: -16px;
            background-color: var(--unh-blue);
            color: white;
        }

        .assistant-message .message-avatar {
            left: -16px;
            background-color: var(--unh-blue);
            color: white;
        }

        .input-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background-color: #e6e6fa;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }

        .input-group {
            background-color: var(--unh-white);
            border-radius: 2rem;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #user-input {
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background: transparent;
        }

        #user-input:focus {
            box-shadow: none;
        }

        #send-button, #uploadButton {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #003591;
            color: var(--btn-text);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }

        #send-button:hover, #uploadButton:hover {
            background-color: #003591;
            transform: scale(1.05);
        }

        .chat-history::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(0, 53, 145, 0.5);
            border-radius: 4px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 53, 145, 0.7);
        }

        .scroll-wrapper {
            max-height: 300px;
            min-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 10px;
            background-color: white;
        }

        .scroll-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .scroll-wrapper::-webkit-scrollbar-thumb {
            background: rgba(0, 53, 145, 0.5);
            border-radius: 4px;
        }

        .scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 53, 145, 0.7);
        }

        .scroll-wrapper table {
            width: 100%;
            border-collapse: collapse;
        }

        .scroll-wrapper table td, .scroll-wrapper table th {
            border: 1px solid #ddd;
            padding: 12px;
            vertical-align: top;
        }

        .modern-btn {
            background: linear-gradient(135deg, #003591, #003591);
            color: white;
            font-size: 16px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .modern-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                border-radius: 0;
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 0.75rem;
                height: 70px;
            }

            .chat-header-title {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container-fluid h-100 p-0">
            <div class="row h-100 m-0">
                <div class="col-12 p-0">
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="header-content">
                                <h1 class="chat-header-title">NECHE Syllabus Assistant</h1>
                            </div>
                        </div>
                        <div class="chat-history" id="chat-history"></div>
                        <div class="input-area">
                            <div class="input-area p-3 bg-light border-top">
                                <div class="d-flex align-items-center gap-2">
                                  <!-- file‑picker stays hidden -->
                                  <input
                                    type="file"
                                    id="fileInput"
                                    accept=".pdf,.docx,.zip"
                                    multiple
                                    style="display: none;"
                                  >
                              
                                  <!-- primary action buttons -->
                                  <button id="uploadFiles" class="btn btn-outline-primary">
                                    <i class="fas fa-file-upload me-1"></i> Upload Files
                                  </button>
                                  <button id="uploadFolder" class="btn btn-outline-secondary">
                                    <i class="fas fa-folder-open me-1"></i> Upload Folder
                                  </button>
                              
                              
                                  <!-- text input grows to fill -->
                                  <input
                                    type="text"
                                    id="user-input"
                                    class="form-control ms-auto"
                                    placeholder="Type your text here..."
                                  >
                                  <button id="send-button" class="btn btn-primary ms-2">
                                    <i class="fas fa-paper-plane"></i>
                                  </button>
                                </div>
                              </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chatHistory = document.getElementById("chat-history");
            const userInput = document.getElementById("user-input");
            const sendButton = document.getElementById("send-button");
            const fileInput = document.getElementById("fileInput");
            const uploadFiles    = document.getElementById("uploadFiles");
            const uploadFolder   = document.getElementById("uploadFolder");


            let latestReportData = null;
            let allResults = [];

            function displayWelcomeMessage() {
                addHTMLMessage("Welcome to the NECHE Compliance Assistant. Upload a PDF, DOCX, ZIP file, or a folder containing these files to check compliance.", false);
            }
            window.addEventListener("load", displayWelcomeMessage);

            function addHTMLMessage(htmlContent, isUser) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", isUser ? "user-message" : "assistant-message");

                const chatIcon = document.createElement("div");
                chatIcon.classList.add("message-avatar");
                chatIcon.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

                const messageContent = document.createElement("div");
                messageContent.classList.add("message-content");
                messageContent.innerHTML = htmlContent;

                messageDiv.appendChild(chatIcon);
                messageDiv.appendChild(messageContent);

                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            sendButton.addEventListener("click", handleSend);
            userInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    handleSend();
                }
            });

            function handleSend() {
                const message = userInput.value.trim();
                if (!message) return;

                addHTMLMessage(message, true);
                userInput.value = "";

                const casualGreetings = {
                    "hi": "Hey! This is NECHE Compliance Assistant. How can I help you?",
                    "hello": "Hello! How can I assist you today?",
                    "hey": "Hey there! Need help with NECHE syllabus compliance?",
                    "what's up": "Not much, just assisting with NECHE compliance. What’s up with you?",
                    "how are you?": "I'm great! Thanks for asking. How can I help you?",
                    "what is your purpose?": "I'm here to help you check if your syllabus meets NECHE compliance and minimal syllabus requirements!",
                    "what type of document can I upload?": "You can upload PDF, DOCX, ZIP files, or a folder containing these files.",
                    "can i upload pdf?": "Yep! Feel free to upload a PDF or a folder containing PDFs.",
                    "tell me about chatbot features?": "Sure! I check if your uploaded documents meet NECHE compliance and minimal syllabus requirements. You can send text or upload files/folders!"
                };

                const userMessage = message.toLowerCase().trim();
                if (casualGreetings[userMessage]) {
                    addHTMLMessage(casualGreetings[userMessage], false);
                    return;
                }

                fetch("/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message }),
                })
                .then(response => response.json())
                .then(data => {
                    addHTMLMessage(data.response, false);
                })
                .catch(() => addHTMLMessage("⚠️ Error: Unable to communicate with the server.", false));
            }

            uploadFiles.addEventListener("click", () => {
            fileInput.removeAttribute("webkitdirectory");
            fileInput.removeAttribute("directory");
            fileInput.accept   = ".pdf,.docx,.zip";
            fileInput.multiple = true;
            fileInput.click();
            });

            uploadFolder.addEventListener("click", () => {
            fileInput.setAttribute("webkitdirectory", "");
            fileInput.setAttribute("directory", "");
            fileInput.accept   = ".pdf,.docx,.zip";
            fileInput.multiple = true;
            fileInput.click();
            });

            fileInput.addEventListener("change", function (e) {
                const files = e.target.files;
                if (!files.length) return;

                const allowedExtensions = [".pdf", ".docx", ".zip"];
                const validFiles = Array.from(files).filter(file =>
                    allowedExtensions.some(ext => file.name.toLowerCase().endsWith(ext))
                );

                if (!validFiles.length) {
                    addHTMLMessage("Only PDF, DOCX, or ZIP files are supported.", false);
                    fileInput.value = "";
                    return;
                }

                const isFolderUpload = validFiles.some(file => file.webkitRelativePath && file.webkitRelativePath.includes("/"));
                const fileNames = validFiles.map(f => f.name).join(", ");
                addHTMLMessage(`<strong>Uploaded ${isFolderUpload ? "folder containing" : "files"}:</strong> ${fileNames}`, true);

                handleFileUpload(validFiles);
            });

            function handleFileUpload(files) {
                latestReportData = null;
                allResults = [];

                const formData = new FormData();
                files.forEach(file => formData.append("file", file));

                addHTMLMessage(`Processing ${files.length} file(s) for NECHE compliance check...`, false);

                fetch("/upload", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allResults = data.results || files.map((file, index) => ({
                            filename: file.name,
                            extracted_information: data.extracted_information?.[index] || {},
                            compliance_check: data.compliance_check?.[index] || "Compliance status not available."
                        }));
                        latestReportData = allResults[allResults.length - 1]?.extracted_information || {};

                        const optionalFields = [
                            "University Requirements",
                            "Course Prerequisites",
                            "Simultaneous 700/800 Course Designation",
                            "Names and Contact Information for Teaching Assistants",
                            "Sensitive Course Content",
                            "Additional Information as Needed for Program Accreditation (and Other Program Requirements)"
                        ];
                        const isInvalidValue = value => ["n/a", "na", "none", "not found", ""].includes(value.toLowerCase());

                        Object.keys(latestReportData).forEach(field => {
                            if (optionalFields.includes(field) && isInvalidValue(latestReportData[field])) {
                                delete latestReportData[field];
                            }
                        });

                        const scrollWrapper = document.createElement("div");
                        scrollWrapper.className = "scroll-wrapper";

                        const table = document.createElement("table");
                        table.className = "table table-bordered";

                        const thead = document.createElement("thead");
                        thead.innerHTML = `
                            <tr style="background-color: #3a17d8; color: white; text-align: center;">
                                <th style="padding: 12px; width: 40%; border: 1px solid #ddd;">Name of the Document</th>
                                <th style="padding: 12px; width: 20%; border: 1px solid #ddd;">Syllabus Compliance</th>
                                <th style="padding: 12px; width: 40%; border: 1px solid #ddd;">Report</th>
                            </tr>`;
                        table.appendChild(thead);

                        const tbody = document.createElement("tbody");

                        allResults.forEach((result, index) => {
                            const filename = result.filename || `File_${index + 1}`;
                            const reportData = result.extracted_information || {};

                            const requiredNECHEFields = [
                                "Instructor Name", "Title or Rank", "Department or Program Affiliation",
                                "Preferred Contact Method", "Email Address", "Phone Number",
                                "Office Address", "Office Hours", "Location (Physical or Remote)",
                                "Course SLOs", "Credit Hour Workload", "Assignments & Delivery",
                                "Grading Procedures & Final Grade Scale", "Assignment Deadlines & Policies"
                            ];

                            const minimumFields = [
                                "Course Number and Title", "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                                "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                                "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                                "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                                "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                                "Attendance", "Academic Integrity/Plagiarism/AI"
                            ];

                            const missingNECHE = requiredNECHEFields.filter(field => !reportData[field] || reportData[field] === "Not Found");
                            const missingMinimum = minimumFields.filter(field => !reportData[field] || reportData[field] === "Not Found");

                            const passFail = (missingNECHE.length === 0 && missingMinimum.length === 0) ? "Pass" : "Fail";
                            const statusColor = passFail === "Pass" ? "green" : "red";

                            let courseNumberAndTitle = reportData["Course Number and Title"] || "Not Found";
                            let professorName = reportData["Instructor Name"] || "Not Found";
                            let courseNumber = "";
                            let courseTitle = "";

                            if (courseNumberAndTitle !== "Not Found") {
                                const parts = courseNumberAndTitle.split(" ");
                                if (parts.length >= 2) {
                                    const potentialCourseNumber = parts[0] + (parts[1].match(/^\d+$/) ? " " + parts[1] : "");
                                    const courseNumberMatch = potentialCourseNumber.match(/^[A-Z]+ \d+$/);
                                    if (courseNumberMatch) {
                                        courseNumber = potentialCourseNumber;
                                        courseTitle = parts.slice(2).join(" ").trim();
                                    } else {
                                        courseTitle = courseNumberAndTitle.trim();
                                    }
                                } else {
                                    courseTitle = courseNumberAndTitle.trim();
                                }
                            }

                            let courseDetails = [];
                            if (courseNumber) courseDetails.push(`<span style="font-weight: bold;">Course Number:</span> ${courseNumber}`);
                            if (courseTitle) courseDetails.push(`<span style="font-weight: bold;">Course Title:</span> ${courseTitle}`);
                            if (professorName !== "Not Found") courseDetails.push(`<span style="font-weight: bold;">Professor:</span> ${professorName}`);

                            let statusHeading = courseDetails.length > 0 ? `
                                <div style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 4px;">
                                    ${courseDetails.join("<br>")}
                                </div>` : "";

                            let formattedComplianceMessage = result.compliance_check || "Compliance status not available.";
                            const urlRegex = /(https?:\/\/[^\s]+)/g;
                            formattedComplianceMessage = formattedComplianceMessage.replace(urlRegex, url => {
                                return `<a href="${url}" target="_blank" style="color: #1a73e8; text-decoration: underline; word-break: break-all;">${url}</a>`;
                            });

                            const fullStatusMessage = `
                                <div style="line-height: 1.5;">
                                    ${statusHeading}
                                    <div style="margin-top: 10px;">
                                        ${formattedComplianceMessage}
                                    </div>
                                </div>`;

                            const row = document.createElement("tr");

                            const nameCell = document.createElement("td");
                            nameCell.style.padding = "10px";
                            nameCell.style.border = "1px solid #ddd";
                            nameCell.innerHTML = `<strong>${filename}</strong>`;
                            row.appendChild(nameCell);

                            const statusCell = document.createElement("td");
                            statusCell.style.padding = "10px";
                            statusCell.style.textAlign = "center";
                            statusCell.style.border = "1px solid #ddd";
                            statusCell.innerHTML = `<strong style="color: ${statusColor};">${passFail}</strong>`;
                            row.appendChild(statusCell);

                            const buttonCell = document.createElement("td");
                            buttonCell.style.padding = "10px";
                            buttonCell.style.textAlign = "center";
                            buttonCell.style.border = "1px solid #ddd";

                            const viewBtn = createStyledButton("View", "modern-btn", () => showReportModal(reportData));
                            const summaryBtn = createStyledButton("Summary", "modern-btn", () => {
                                showCompliancePopupClean(reportData, filename, result.compliance_check);
                            });
                            const shareBtn = createStyledButton("Share", "modern-btn", () => {
                                const professorEmail = reportData["Email Address"] || "";
                                const course = reportData["Course Number and Title"] || "Course";
                                const professorName = reportData["Instructor Name"] || "Professor";

                                if (!professorEmail) {
                                    alert("⚠️ No professor email found in the syllabus data.");
                                    return;
                                }

                                const confirmed = confirm("Do you want to share this report via Outlook?");
                                if (!confirmed) return;

                                const summaryStatus = result.compliance_check || "Compliance status not available.";
                                const requiredFields = [
                                    "Instructor Name", "Title or Rank", "Department or Program Affiliation",
                                    "Preferred Contact Method", "Email Address", "Phone Number",
                                    "Office Address", "Office Hours", "Location (Physical or Remote)",
                                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery",
                                    "Grading Procedures & Final Grade Scale", "Assignment Deadlines & Policies"
                                ];

                                const minimumFields = [
                                    "Course Number and Title",
                                    "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                                    "Modality/Meeting Time and Place",
                                    "Semester/Term (and start/end dates)",
                                    "Department/Program",
                                    "Format (e.g., lecture plus lab/discussion etc.)",
                                    "Course Description (minimum course catalog description)",
                                    "Sequence of Course Topics and Important Dates",
                                    "Required/Recommended Textbook (or other source for course reference information)",
                                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)",
                                    "Technical Requirements",
                                    "Attendance",
                                    "Academic Integrity/Plagiarism/AI"
                                ];

                                const isMissing = value => {
                                    return value === undefined || value === null || value === "Not Found" || (typeof value === "string" && value.trim() === "");
                                };

                                const missingNECHE = requiredFields.filter(field => isMissing(reportData[field]));
                                const missingMinimum = minimumFields.filter(field => isMissing(reportData[field]));

                                const subject = `NECHE Syllabus Review for ${course}`;
                                let body;
                                if (missingNECHE.length === 0 && missingMinimum.length === 0) {
                                    body = `Dear ${professorName},\n\n` +
                                           `I’m pleased to inform you that your syllabus for ${course} is fully compliant with all NECHE and minimum requirements.\n\n` +
                                           `Best regards,\nSai Shiva\njsaishiva@unh.com`;
                                } else {
                                    body = `Dear ${professorName},\n\n` +
                                           `The NECHE compliance review for your syllabus for ${course} identified the following missing requirements:\n\n` +
                                           `${missingNECHE.length > 0 ? `**NECHE Requirements**:\n- ${missingNECHE.join("\n- ")}\n` : ""}` +
                                           `${missingMinimum.length > 0 ? `**Minimum Requirements**:\n- ${missingMinimum.join("\n- ")}\n` : ""}` +
                                           `Please address these items and let me know if you need assistance.\n\n` +
                                           `Best regards,\nSai Shiva\njsaishiva@unh.com`;
                                }

                                const mailtoLink = `mailto:${encodeURIComponent(professorEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                                window.location.href = mailtoLink;
                            });

                            viewBtn.style.marginRight = "8px";
                            summaryBtn.style.marginRight = "8px";
                            shareBtn.style.marginRight = "8px";

                            buttonCell.appendChild(viewBtn);
                            buttonCell.appendChild(summaryBtn);
                            buttonCell.appendChild(shareBtn);
                            row.appendChild(buttonCell);

                            tbody.appendChild(row);
                        });

                        table.appendChild(tbody);
                        scrollWrapper.appendChild(table);
                        chatHistory.appendChild(scrollWrapper);

                        if (allResults.length > 1) {
                            const allBtnWrapper = document.createElement("div");
                            allBtnWrapper.style.textAlign = "center";
                            allBtnWrapper.style.marginTop = "20px";

                            const allReportsBtn = createStyledButton("Download All Reports", "modern-btn", () => downloadAllReports(allResults));
                            allBtnWrapper.appendChild(allReportsBtn);
                            chatHistory.appendChild(allBtnWrapper);
                        }
                    } else {
                        throw new Error(`Upload failed: ${data.error}`);
                    }
                })
                .catch(error => addHTMLMessage(`⚠️ ${error.message}`, false));
            }

            function createStyledButton(text, classes, clickHandler) {
                const button = document.createElement("button");
                button.textContent = text;
                button.className = `${classes}`;
                button.style.margin = "10px";
                button.addEventListener("click", clickHandler);
                return button;
            }

            function downloadSingleReport(data, filename) {
                function loadScript(src, callback) {
                    const script = document.createElement("script");
                    script.src = src;
                    script.onload = callback;
                    script.onerror = () => {
                        console.error(`Failed to load script: ${src}`);
                        alert(`⚠️ Error: Failed to load required library: ${src}`);
                    };
                    document.head.appendChild(script);
                }

                if (!window.jspdf) {
                    console.warn("jsPDF is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js", () => {
                        console.log("jsPDF loaded successfully.");
                        if (!window.jspdfAutoTable) {
                            console.warn("jsPDF-AutoTable is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js", () => {
                                console.log("jsPDF-AutoTable loaded successfully.");
                                generateReport(data, filename);
                            });
                        } else {
                            generateReport(data, filename);
                        }
                    });
                } else if (!window.jspdfAutoTable) {
                    console.warn("jsPDF-AutoTable is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js", () => {
                        console.log("jsPDF-AutoTable loaded successfully.");
                        generateReport(data, filename);
                    });
                } else {
                    generateReport(data, filename);
                }

                function generateReport(data, filename) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const requiredFields = [
                        "Instructor Name", "Title or Rank", "Department or Program Affiliation", "Preferred Contact Method",
                        "Email Address", "Phone Number", "Office Address", "Office Hours", "Location (Physical or Remote)",
                        "Course SLOs", "Credit Hour Workload", "Assignments & Delivery", "Grading Procedures & Final Grade Scale",
                        "Assignment Deadlines & Policies"
                    ];

                    const minimumFields = [
                        "Course Number and Title",
                        "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                        "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                        "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                        "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                        "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                        "Attendance", "Academic Integrity/Plagiarism/AI"
                    ];

                    const optionalFields = [
                        "Course Prerequisites",
                        "Simultaneous 700/800 Course Designation",
                        "University Requirements",
                        "Teaching Assistants (Names and Contact Information)"
                    ];
                    const allFields = [...requiredFields, ...minimumFields, ...optionalFields];
                    const tableColumn = ["Syllabus Items", "Syllabus Details"];
                    const tableRows = [];

                    allFields.forEach(field => {
                        const value = data[field] || "Not Found";
                        const isOptional = optionalFields.includes(field);

                        if (isOptional && value === "Not Found") return;

                        let displayField = field;
                        if (requiredFields.includes(field)) {
                            displayField = `**${field}**`;
                        } else if (optionalFields.includes(field)) {
                            displayField = `***${field}***`;
                        }

                        const displayValue = value === "Not Found" ? "Not Found" : value;
                        tableRows.push([displayField, displayValue]);
                    });

                    let title = "NECHE Compliance Report";
                    const course = data["Course Number and Title"];
                    const professor = data["Instructor Name"];

                    const headingParts = [];
                    if (course && course !== "Not Found") headingParts.push(course);
                    if (professor && professor !== "Not Found") headingParts.push(`by Professor ${professor}`);

                    if (headingParts.length > 0) title += " – " + headingParts.join(" ");

                    doc.setFontSize(12);
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 10;
                    const maxWidth = pageWidth - 2 * margin;
                    const splitTitle = doc.splitTextToSize(title, maxWidth);

                    let yPosition = 15;
                    splitTitle.forEach((line, index) => {
                        const textWidth = doc.getTextWidth(line);
                        const xPosition = (pageWidth - textWidth) / 2;
                        doc.text(line, xPosition, yPosition + (index * 5));
                    });

                    const titleHeight = splitTitle.length * 5;
                    const tableStartY = yPosition + titleHeight + 5;

                    doc.autoTable({
                        startY: tableStartY,
                        head: [tableColumn],
                        body: tableRows,
                        theme: "grid",
                        headStyles: {
                            fillColor: [58, 23, 216],
                            textColor: [255, 255, 255],
                            fontSize: 10,
                        },
                        styles: {
                            fontSize: 10,
                            cellPadding: 4,
                        },
                        columnStyles: {
                            0: { fillColor: [245, 245, 245] },
                            1: { fillColor: [255, 255, 255] },
                        },
                        didParseCell: function (data) {
                            if (data.column.index === 0) {
                                let text = data.cell.text[0];
                                if (text.startsWith("***") && text.endsWith("***")) {
                                    data.cell.text[0] = text.slice(3, -3);
                                    data.cell.styles.fontStyle = "italic";
                                } else if (text.startsWith("**") && text.endsWith("**")) {
                                    data.cell.text[0] = text.slice(2, -2);
                                    data.cell.styles.fontStyle = "bold";
                                } else {
                                    data.cell.styles.fontStyle = "normal";
                                }
                            }

                            if (data.column.index === 1 && data.cell.text[0] === "Not Found") {
                                data.cell.styles.textColor = [255, 0, 0];
                                data.cell.styles.fontStyle = "bold";
                            }
                        }
                    });

                    doc.save(`${filename}_NECHE_Report.pdf`);
                }
            }

            function showReportModal(data) {
                const requiredFields = [
                    "Instructor Name", "Title or Rank", "Department or Program Affiliation", "Preferred Contact Method",
                    "Email Address", "Phone Number", "Office Address", "Office Hours", "Location (Physical or Remote)",
                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery", "Grading Procedures & Final Grade Scale",
                    "Assignment Deadlines & Policies"
                ];

                const minimumFields = [
                    "Course Number and Title",
                    "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                    "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                    "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                    "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                    "Attendance", "Academic Integrity/Plagiarism/AI"
                ];

                const optionalFields = [
                    "Course Prerequisites",
                    "Simultaneous 700/800 Course Designation",
                    "University Requirements",
                    "Teaching Assistants (Names and Contact Information)"
                ];
                const allFields = [...requiredFields, ...minimumFields, ...optionalFields];

                let html = `<html><head>
                    <title>NECHE Report</title>
                    <style>
                        body { font-family: "Segoe UI", sans-serif; padding: 20px; background: #f9f9fb; color: #333; max-width: 1000px; margin: auto; }
                        h2 { font-size: 20px; text-align: center; margin-bottom: 20px; font-weight: 600; color: #2a2a2a; }
                        table { width: 100%; border-collapse: collapse; border: 1px solid #ccc; font-size: 14px; }
                        th, td { padding: 8px 10px; border: 1px solid #ddd; vertical-align: top; text-align: left; }
                        th { background-color: #3a17d8; color: white; font-weight: 600; }
                        td:first-child { background-color: #f5f5f5; }
                        td:last-child { background-color: #ffffff; }
                        .download-btn { margin-top: 20px; display: block; width: fit-content; margin-left: auto; margin-right: auto; background-color: #3a17d8; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; transition: 0.3s ease; }
                        .download-btn:hover { background-color: #2a0fa6; }
                    </style>
                </head><body>`;

                let courseTitleRaw = data["Course Number and Title"];
                let instructor = data["Instructor Name"];
                let headingParts = [];

                if (courseTitleRaw && courseTitleRaw !== "Not Found") headingParts.push(courseTitleRaw);
                if (instructor && instructor !== "Not Found") headingParts.push(`by Professor ${instructor}`);

                let headingText = "NECHE Compliance Report";
                if (headingParts.length) headingText += " – " + headingParts.join(" ");

                html += `<h2>${headingText}</h2>`;
                html += `<table><thead><tr><th>Syllabus Items</th><th>Syllabus Details</th></tr></thead><tbody>`;

                allFields.forEach(field => {
                    const value = data[field] || "Not Found";
                    const isOptional = optionalFields.includes(field);

                    if (isOptional && value === "Not Found") return;

                    let formattedField = field;
                    if (requiredFields.includes(field)) {
                        formattedField = `<strong>${field}</strong>`;
                    } else if (optionalFields.includes(field)) {
                        formattedField = `<em>${field}</em>`;
                    }

                    const displayValue = value === "Not Found" ? `<span style="color: red; font-weight: bold;">Not Found</span>` : value;

                    html += `<tr><td>${formattedField}</td><td>${displayValue}</td></tr>`;
                });

                html += `</tbody></table>`;
                const safeData = encodeURIComponent(JSON.stringify(data));
                html += `<button class="download-btn" onclick="window.opener.downloadSingleReport(JSON.parse(decodeURIComponent('${safeData}')), '${data["Course Number and Title"] || "Report"}')">Download PDF</button>`;
                html += `</body></html>`;

                const newWin = window.open("", "_blank");
                newWin.document.open();
                newWin.document.write(html);
                newWin.document.close();
            }

            function downloadAllReports(results) {
                function loadScript(src, callback) {
                    const script = document.createElement("script");
                    script.src = src;
                    script.onload = callback;
                    script.onerror = () => {
                        console.error(`Failed to load script: ${src}`);
                        alert(`⚠️ Error: Failed to load required library: ${src}`);
                    };
                    document.head.appendChild(script);
                }

                if (!window.jspdf) {
                    console.warn("jsPDF is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js", () => {
                        console.log("jsPDF loaded successfully.");
                        if (!window.jspdfAutoTable) {
                            console.warn("jsPDF-AutoTable is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js", () => {
                                console.log("jsPDF-AutoTable loaded successfully.");
                                if (!window.JSZip) {
                                    console.warn("JSZip is not loaded. Loading it now...");
                                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                                        console.log("JSZip loaded successfully.");
                                        generateAllReports(results);
                                    });
                                } else {
                                    generateAllReports(results);
                                }
                            });
                        } else if (!window.JSZip) {
                            console.warn("JSZip is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                                console.log("JSZip loaded successfully.");
                                generateAllReports(results);
                            });
                        } else {
                            generateAllReports(results);
                        }
                    });
                } else if (!window.jspdfAutoTable) {
                    console.warn("jsPDF-AutoTable is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js", () => {
                        console.log("jsPDF-AutoTable loaded successfully.");
                        if (!window.JSZip) {
                            console.warn("JSZip is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                                console.log("JSZip loaded successfully.");
                                generateAllReports(results);
                            });
                        } else {
                            generateAllReports(results);
                        }
                    });
                } else if (!window.JSZip) {
                    console.warn("JSZip is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                        console.log("JSZip loaded successfully.");
                        generateAllReports(results);
                    });
                } else {
                    generateAllReports(results);
                }

                function generateAllReports(results) {
                    const { jsPDF } = window.jspdf;
                    const zip = new JSZip();

                    if (!jsPDF || !JSZip) {
                        console.error("Required libraries (jsPDF or JSZip) are not loaded.");
                        alert("⚠️ Error: Required libraries not loaded.");
                        return;
                    }

                    results.forEach((result, index) => {
                        const doc = new jsPDF();
                        const filename = result.filename || `File_${index + 1}`;
                        const reportData = result.extracted_information || {};

                        const title = `NECHE Compliance Report - ${filename}`;
                        doc.setFontSize(12);
                        doc.text(title, 10, 10);

                        const tableColumn = ["Syllabus Items", "Syllabus Details"];
                        const tableRows = [];

                        Object.keys(reportData).forEach(key => {
                            const value = reportData[key] || "Not Found";
                            tableRows.push([key, value]);
                        });

                        doc.autoTable({
                            startY: 20,
                            head: [tableColumn],
                            body: tableRows,
                            theme: "grid",
                            headStyles: {
                                fillColor: [58, 23, 216],
                                textColor: [255, 255, 255],
                                fontSize: 10,
                            },
                            styles: {
                                fontSize: 10,
                                cellPadding: 4,
                            },
                        });

                        const pdfBlob = doc.output("blob");
                        zip.file(`${filename}_NECHE_Report.pdf`, pdfBlob);
                    });

                    zip.generateAsync({ type: "blob" }).then(content => {
                        const zipBlob = new Blob([content], { type: "application/zip" });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(zipBlob);
                        link.download = "NECHE_Reports.zip";
                        link.click();
                    });
                }
            }

            function showCompliancePopupClean(data, filename, complianceStatus) {
                const requiredFields = [
                    "Instructor Name", "Title or Rank", "Department or Program Affiliation",
                    "Preferred Contact Method", "Email Address", "Phone Number",
                    "Office Address", "Office Hours", "Location (Physical or Remote)",
                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery",
                    "Grading Procedures & Final Grade Scale", "Assignment Deadlines & Policies"
                ];

                const minimumFields = [
                    "Course Number and Title",
                    "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                    "Modality/Meeting Time and Place",
                    "Semester/Term (and start/end dates)",
                    "Department/Program",
                    "Format (e.g., lecture plus lab/discussion etc.)",
                    "Course Description (minimum course catalog description)",
                    "Sequence of Course Topics and Important Dates",
                    "Required/Recommended Textbook (or other source for course reference information)",
                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)",
                    "Technical Requirements",
                    "Attendance",
                    "Academic Integrity/Plagiarism/AI"
                ];

                const missingNECHE = requiredFields.filter(field => data[field] === "Not Found" || !data[field]);
                const missingMinimum = minimumFields.filter(field => data[field] === "Not Found" || !data[field]);

                const courseRaw = data["Course Number and Title"] || "Not Found";
                const professor = data["Instructor Name"] || "Not Found";

                let courseNumber = "";
                let courseTitle = courseRaw;
                const parts = courseRaw.split(" ");
                if (parts.length >= 2 && /^[A-Z]{2,}\d{2,}/.test(parts[0] + parts[1])) {
                    courseNumber = parts[0] + " " + parts[1];
                    courseTitle = parts.slice(2).join(" ");
                }

                const isCompliant = missingNECHE.length === 0 && missingMinimum.length === 0;
                const statusColor = isCompliant ? "green" : "red";
                const statusText = isCompliant ? "Pass" : "Fail";

                const popupOverlay = document.createElement("div");
                popupOverlay.id = "compliance-popup";
                popupOverlay.style.position = "fixed";
                popupOverlay.style.top = "0";
                popupOverlay.style.left = "0";
                popupOverlay.style.width = "100vw";
                popupOverlay.style.height = "100vh";
                popupOverlay.style.backgroundColor = "rgba(0,0,0,0.5)";
                popupOverlay.style.display = "flex";
                popupOverlay.style.justifyContent = "center";
                popupOverlay.style.alignItems = "center";
                popupOverlay.style.zIndex = "9999";

                const popup = document.createElement("div");
                popup.style.background = "#ffffff";
                popup.style.borderRadius = "10px";
                popup.style.padding = "25px";
                popup.style.width = "90%";
                popup.style.maxWidth = "650px";
                popup.style.maxHeight = "85vh";
                popup.style.overflowY = "auto";
                popup.style.fontFamily = "Segoe UI, sans-serif";
                popup.style.boxShadow = "0 10px 30px rgba(0,0,0,0.3)";
                popup.style.color = "#000000";

                let popupContent = `
                    <div style="background-color: #003591; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 18px; border-top-left-radius: 10px; border-top-right-radius: 10px;">
                        Summary
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Course Number</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${courseNumber ? courseNumber : "N/A"}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Course Title</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${courseTitle !== "Not Found" ? courseTitle : "N/A"}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Professor</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${professor !== "Not Found" ? professor : "N/A"}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Compliance Status</td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${statusText}</td>
                        </tr>
                    </table>
                    <div style="font-weight: bold; color: ${statusColor}; margin-bottom: 20px; text-align: center;">
                        The compliance check is complete. The syllabus is ${isCompliant ? "NECHE compliant." : "not NECHE compliant.<br>Here is the missing information."}
                    </div>`;

                if (missingNECHE.length > 0) {
                    popupContent += `
                        <div style="margin-top: 10px; text-align: left;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #003591; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Missing NECHE Requirements</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${missingNECHE.map(field => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${field}</td>
                                        </tr>`).join("")}
                                </tbody>
                            </table>
                        </div>`;
                }

                if (missingMinimum.length > 0) {
                    popupContent += `
                        <div style="margin-top: 20px; text-align: left;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #003591; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Missing Minimum Requirements</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${missingMinimum.map(field => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${field}</td>
                                        </tr>`).join("")}
                                </tbody>
                            </table>
                        </div>`;
                }

                popupContent += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="closeCompliancePopup" style="background-color: #000000; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>`;

                popup.innerHTML = popupContent;
                popupOverlay.appendChild(popup);
                document.body.appendChild(popupOverlay);

                document.getElementById("closeCompliancePopup").addEventListener("click", () => {
                    popupOverlay.remove();
                });
            }
        });
    </script>
</body>
</html>