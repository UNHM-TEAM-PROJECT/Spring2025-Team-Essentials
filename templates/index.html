<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Syllabus Compliance Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --unh-blue: #003591;
            --unh-white: #ffffff;
            --chat-bg: rgba(248, 249, 250, 0.95);
            --message-bg: rgba(233, 236, 239, 0.9);
            --input-bg: rgba(248, 249, 250, 0.95);
            --btn-color: #ebf0f9;
            --btn-hover: #9662be;
            --btn-text: #ffffff;
            --border-radius: 0;
            --unh-black: #403a3a;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            background-image: url('../templates/chatbot-bg.png');
            background-size: 600px;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
        }

        .page-container {
            height: 100vh;
            width: 100vw;
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            margin: 0;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--unh-blue) 0%, #003591 100%);
            color: var(--unh-white);
            padding: 1rem;
            display: flex;
            justify-content: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            height: 80px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header img {
            height: 60px;
            width: auto;
            object-fit: contain;
        }

        .chat-header-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: transparent;
            background-image: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('/Users/bubby/TeamGulliver/static/logo.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .edit-icon-container {
            position: absolute;
            bottom: 40px;
            right: -2px;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-icon {
            font-size: 16px;
            color: var(--unh-black);
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        .edit-icon:hover {
            color: var(--unh-blue);
        }

        .message {
            position: relative;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 1rem;
            max-width: 75%;
            animation: fadeIn 0.3s ease-in-out;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
            text-align: left;
        }

        .assistant-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            backdrop-filter: blur(5px);
            text-align: left;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            position: absolute;
            bottom: -16px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .message-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .edit-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .cancel-button,
        .send-button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1.2;
        }

        .cancel-button {
            background-color: #f5f5f5;
            color: #333;
        }

        .send-button {
            background-color: var(--unh-blue);
            color: #fff;
        }

        .send-button:hover {
            background-color: #001F5C;
        }

        .cancel-button:hover {
            background-color: #e0e0e0;
        }

        .user-message .message-avatar {
            right: -16px;
            background-color: var(--unh-blue);
            color: white;
        }

        .assistant-message .message-avatar {
            left: -16px;
            background-color: var(--unh-blue);
            color: white;
        }

        .input-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: #e6e6fa;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }

        .search-container {
            display: flex;
            align-items: center;
            background: var(--unh-white);
            border: 2px solid var(--unh-blue);
            border-radius: 10px;
            padding: 10px 14px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .search-container:hover {
            border-color: #001F5C;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .search-container:focus-within {
            transform: translateX(5px);
            border-color: var(--unh-blue);
            box-shadow: 0 0 10px rgba(0, 53, 145, 0.5);
        }

        .search-container input {
            border: none;
            outline: none;
            padding: 12px;
            font-size: 1.1rem;
            flex: 1;
            background: transparent;
        }

        .search-container button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: var(--unh-blue);
            color: var(--btn-text);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: 8px;
            font-size: 1rem;
        }

        .search-container button:hover {
            background-color: #001F5C;
            transform: scale(1.05);
        }

        .edit-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--unh-black);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .chat-history::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(0, 53, 145, 0.5);
            border-radius: 4px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 53, 145, 0.7);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            font-size: 1rem;
            color: #666;
            margin-top: 10px;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            margin: 0 2px;
            animation: blink 1s infinite alternate;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                border-radius: 0;
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 0.75rem;
                height: 70px;
            }

            .chat-header img {
                height: 60px;
            }

            .chat-header-title {
                font-size: 1.2rem;
            }

            .search-container {
                max-width: 95%;
            }

            .search-container input {
                padding: 10px;
                font-size: 1rem;
            }

            .search-container button {
                padding: 8px 14px;
                font-size: 0.9rem;
            }
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .upload-area {
            border: 2px dashed var(--unh-blue);
            padding: 30px;
            cursor: pointer;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            background-color: #eaf4ff;
            transition: background 0.3s ease;
        }

        .upload-area:hover {
            background: #d6ebff;
        }

        .upload-area.dragover {
            background: #c2e0ff;
            border-color: var(--unh-blue);
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 10px;
            font-size: 16px;
            color: var(--unh-blue);
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .modern-btn {
            background: linear-gradient(135deg, var(--unh-blue), var(--unh-blue));
            color: white;
            font-size: 16px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
        }

        .modern-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        #viewReport:hover,
        #downloadReport:hover,
        #viewReportBtn:hover,
        #downloadReportBtn:hover {
            background: #000 !important;
            color: #fff !important;
            transform: scale(1.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .modern-btn:active::after {
            content: "";
            position: absolute;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            animation: ripple 0.5s ease-out;
        }

        @keyframes ripple {
            from {
                width: 0;
                height: 0;
                opacity: 1;
            }
            to {
                width: 200%;
                height: 200%;
                opacity: 0;
            }
        }

        .neche-detailed-report table {
            border-collapse: collapse !important;
            width: 100%;
            margin: 0;
            border: 1px solid #ddd;
        }

        .neche-detailed-report table tr {
            border: none;
        }

        .neche-detailed-report table td, 
        .neche-detailed-report table th {
            border: 1px solid #ddd;
            padding: 12px;
            vertical-align: top;
        }

        .neche-detailed-report {
            max-height: none !important;
            overflow: visible !important;
        }

        .chat-history {
            overflow-y: auto !important;
            max-height: none !important;
            display: flex !important;
            flex-direction: column !important;
            flex-shrink: 0 !important;
        }

        .scroll-wrapper {
            max-height: 300px !important;
            min-height: 150px !important;
            overflow-y: auto !important;
            width: 100% !important;
            flex-shrink: 0 !important;
            border: 1px solid #ddd !important;
            margin-top: 20px !important;
            margin-bottom: 20px !important;
            padding: 10px !important;
            background-color: white !important;
        }

        .scroll-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .scroll-wrapper::-webkit-scrollbar-thumb {
            background: rgba(0, 53, 145, 0.5);
            border-radius: 4px;
        }

        .scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 53, 145, 0.7);
        }

        .scroll-wrapper table {
            width: 100% !important;
            border-collapse: collapse !important;
        }

        .scroll-wrapper table td,
        .scroll-wrapper table th {
            border: 1px solid #ddd;
            padding: 12px;
            vertical-align: top;
        }

        .neche-detailed-report {
            max-height: none !important;
            overflow: visible !important;
            width: 100% !important;
            flex-shrink: 0 !important;
        }

        .scroll-wrapper + div {
            margin-top: 0 !important;
            border-top: none !important;
        }

        .modal-content {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--unh-blue);
            color: #ffffff;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .modal-footer {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            background-color: #f1f3f5;
            padding: 15px 25px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container-fluid h-100 p-0">
            <div class="row h-100 m-0">
                <div class="col-12 p-0">
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="header-content">
                                <h1 class="chat-header-title">Syllabus Compliance Assistant</h1>
                            </div>
                        </div>
                        <div class="chat-history" id="chat-history"></div>
                        <div class="input-area">
                            <div class="search-container">
                                <input type="text" id="user-input" placeholder="Ask your syllabus questions...">
                                <button id="send-button"><i class="fas fa-paper-plane"></i> Send</button>
                                <button id="uploadButton"><i class="fas fa-upload"></i> Upload</button>
                                <button id="folderUploadButton"><i class="fas fa-folder-plus"></i> Folder</button>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.docx,.zip" style="display: none;">
                            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 style="text-align: center; font-weight: bold; margin-bottom: 20px;">Syllabus Requirement List</h2>
    <div id="reportButtons" style="display: none; text-align: center; margin-top: 20px;">
        <button id="viewReport" class="modern-btn">View Report</button>
        <button id="downloadReport" class="modern-btn">Download Report</button>
    </div>
    <table style="width: 100%; border-collapse: collapse; font-size: 16px; text-align: left; background: white; box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden;">
        <thead>
            <tr style="background-color: var(--unh-blue); color: white; text-align: center;">
                <th style="padding: 15px; border: 1px solid #ddd; width: 40%;">Syllabus Items</th>
                <th style="padding: 15px; border: 1px solid #ddd; width: 60%;">Syllabus Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">Compose Email</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label for="email-from" class="form-label">From:</label>
                        <input type="text" class="form-control" id="email-from" value="Essentials2025UNH@gmail.com" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="email-to" class="form-label">To:</label>
                        <input type="text" class="form-control" id="email-to" value="">
                    </div>
                    <div class="mb-4">
                        <label for="email-subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="email-subject">
                    </div>
                    <div class="mb-4">
                        <label for="email-body" class="form-label">Body:</label>
                        <textarea class="form-control" id="email-body" rows="8"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Attachment:</label>
                        <p>NECHE_Requirements_Table.pdf</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="send-email-btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="upload-area" id="uploadArea">
            <p>Drag & Drop your syllabus file here or <span style="color: var(--unh-blue); font-weight: bold;">Click to Upload</span></p>
            <input type="file" id="fileInput" accept=".pdf, .docx">
            <p class="file-info" id="fileInfo">No file chosen</p>
        </div>

        <div class="button-container">
            <button id="uploadBtn" class="modern-btn">Upload File</button>
            <button id="viewReportBtn" class="modern-btn">View Report</button>
            <button id="downloadReportBtn" class="modern-btn">Download Report</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chatHistory = document.getElementById("chat-history");
            const userInput = document.getElementById("user-input");
            const sendButton = document.getElementById("send-button");
            const fileInput = document.getElementById("fileInput");
            const uploadButton = document.getElementById("uploadButton");
            const folderUploadButton = document.getElementById("folderUploadButton");
            const folderInput = document.getElementById("folderInput");
            const uploadArea = document.getElementById("uploadArea");
            const fileInfo = document.getElementById("fileInfo");
            const uploadBtn = document.getElementById("uploadBtn");
            const viewReportBtn = document.getElementById("viewReportBtn");
            const downloadReportBtn = document.getElementById("downloadReportBtn");
            const viewReport = document.getElementById("viewReport");
            const downloadReport = document.getElementById("downloadReport");

            let latestReportData = null;
            let allResults = [];

            function displayWelcomeMessage() {
                addHTMLMessage("Welcome to the NECHE Compliance and Minimal Syllabus Requirement Assistant. I'm here to assist you in reviewing your syllabus for NECHE compliance. Feel free to upload your files, documents, zip files and folders or ask any questions to get started.", false);
            }
            window.addEventListener("load", displayWelcomeMessage);

            function addHTMLMessage(htmlContent, isUser) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", isUser ? "user-message" : "assistant-message");

                const chatIcon = document.createElement("div");
                chatIcon.classList.add("message-avatar");
                chatIcon.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

                const messageContent = document.createElement("div");
                messageContent.classList.add("message-content");
                messageContent.innerHTML = htmlContent;

                messageDiv.appendChild(chatIcon);
                messageDiv.appendChild(messageContent);

                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            sendButton.addEventListener("click", handleSend);
            userInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    handleSend();
                }
            });

            function handleSend() {
                const message = userInput.value.trim();
                if (!message) return;

                addHTMLMessage(message, true);
                userInput.value = "";

                const casualGreetings = {
                    "hi": "Hey! This is NECHE Compliance Assistant. How can I help you?",
                    "hello": "Hello! How can I assist you today?",
                    "hey": "Hey there! Need help with NECHE syllabus compliance?",
                    "what's up": "Not much, just assisting with NECHE compliance. What’s up with you?",
                    "how are you?": "I'm great! Thanks for asking. How can I help you?",
                    "how is it going": "It's going great! Ready to check your syllabus?",
                    "what is your purpose?": "I'm here to help you check if your syllabus meets NECHE compliance, and minimal syllabus requirements!",
                    "what type of document can I upload?": "You can upload DOC, PDF, or a ZIP file that contains DOC and PDF files.",
                    "can i upload pdf?": "Yep! Feel free to upload a PDF.",
                    "tell me about chatbot features?": "Sure! I check if your uploaded documents meet NECHE compliance, minimal syllabus, and optional syllabus requirements. You can send text, upload files, or even send audio!"
                    
                };

                const userMessage = message.toLowerCase().trim();
                if (casualGreetings[userMessage]) {
                    addHTMLMessage(casualGreetings[userMessage], false);
                    return;
                }

                fetch("/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message }),
                })
                .then(response => response.json())
                .then(data => {
                    addHTMLMessage(data.response, false);
                })
                .catch(() => addHTMLMessage("⚠️ Error: Unable to communicate with the server.", false));
            }

            uploadButton.addEventListener("click", function () {
                fileInput.click();
            });

            uploadArea.addEventListener("click", function () {
                fileInput.click();
            });

            uploadBtn.addEventListener("click", function () {
                fileInput.click();
            });

            fileInput.addEventListener("change", function (e) {
                const files = e.target.files;
                if (!files.length) return;

                const file = files[0];
                if (
                    file &&
                    (
                        file.type === "application/pdf" ||
                        file.name.endsWith(".docx") ||
                        file.name.endsWith(".zip")
                    )
                ) {
                    addHTMLMessage(`<strong>Uploaded:</strong> ${file.name}`, true);
                    fileInfo.textContent = file.name;
                    handleFileUpload(file);
                } else {
                    addHTMLMessage("Only PDF, DOCX, or ZIP files are supported.", false);
                    fileInfo.textContent = "No file chosen";
                    fileInput.value = "";
                }
            });

            folderUploadButton.addEventListener("click", function () {
                folderInput.click();
            });

            folderInput.addEventListener("change", function (e) {
                const files = e.target.files;
                if (!files.length) return;

                const validFiles = Array.from(files).filter(file =>
                    file.type === "application/pdf" ||
                    file.name.endsWith(".docx") ||
                    file.name.endsWith(".zip")
                );

                if (validFiles.length === 0) {
                    addHTMLMessage("No valid PDF, DOCX, or ZIP files found in the folder.", false);
                    folderInput.value = "";
                    return;
                }

                addHTMLMessage(`<strong>Uploaded Folder:</strong> Containing ${validFiles.length} valid file(s)`, true);
                handleFileUpload(validFiles);
            });

            uploadArea.addEventListener("dragover", (e) => {
                e.preventDefault();
                uploadArea.classList.add("dragover");
            });

            uploadArea.addEventListener("dragleave", () => {
                uploadArea.classList.remove("dragover");
            });

            uploadArea.addEventListener("drop", (e) => {
                e.preventDefault();
                uploadArea.classList.remove("dragover");
                const files = e.dataTransfer.files;
                if (!files.length) return;

                const file = files[0];
                if (
                    file &&
                    (
                        file.type === "application/pdf" ||
                        file.name.endsWith(".docx") ||
                        file.name.endsWith(".zip")
                    )
                ) {
                    addHTMLMessage(`<strong>Uploaded:</strong> ${file.name}`, true);
                    fileInfo.textContent = file.name;
                    handleFileUpload(file);
                } else {
                    addHTMLMessage("Only PDF, DOCX, or ZIP files are supported.", false);
                    fileInfo.textContent = "No file chosen";
                }
            });

            function handleFileUpload(files) {
                latestReportData = null;
                allResults = [];
                const reportButtons = document.getElementById("reportButtons");
                if (reportButtons) reportButtons.style.display = "none";

                const fileArray = Array.isArray(files) ? files : [files];
                addHTMLMessage(`Processing ${fileArray.length} file(s) for NECHE compliance check...`, false);

                const batchSize = 10;
                const batches = [];
                for (let i = 0; i < fileArray.length; i += batchSize) {
                    batches.push(fileArray.slice(i, i + batchSize));
                }

                Promise.all(
                    batches.map(batch => {
                        const formData = new FormData();
                        batch.forEach(file => formData.append("file", file));

                        return fetch("/upload", {
                            method: "POST",
                            body: formData,
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (!data.success) {
                                    throw new Error(data.error || "Failed to process files");
                                }
                                return data.results || [];
                            });
                    })
                )
                .then(batchResults => {
                    allResults = batchResults.flat();

                    if (allResults.length === 0) {
                        throw new Error("No valid files processed inside the upload");
                    }

                    latestReportData = allResults[allResults.length - 1].extracted_information || {};

                    const scrollWrapper = document.createElement("div");
                    scrollWrapper.className = "scroll-wrapper";
                    scrollWrapper.style.border = "1px solid #ddd";
                    scrollWrapper.style.marginTop = "20px";
                    scrollWrapper.style.marginBottom = "20px";
                    scrollWrapper.style.padding = "10px";
                    scrollWrapper.style.backgroundColor = "white";

                    const table = document.createElement("table");
                    table.className = "table table-bordered";
                    table.style.marginBottom = "0";
                    table.style.borderCollapse = "collapse";

                    const thead = document.createElement("thead");
                    thead.innerHTML = `
                        <tr style="background-color: var(--unh-blue); color: white; text-align: center;">
                            <th style="padding: 12px; width: 40%; border: 1px solid #ddd;">Name of the Document</th>
                            <th style="padding: 12px; width: 20%; border: 1px solid #ddd;">Syllabus Compliance</th>
                            <th style="padding: 12px; width: 40%; border: 1px solid #ddd;">Report</th>
                        </tr>`;
                    table.appendChild(thead);

                    const tbody = document.createElement("tbody");

                    allResults.forEach((result, index) => {
                        const filename = result.filename || `File_${index + 1}`;
                        const reportData = result.extracted_information || {};

                        const requiredNECHEFields = [
                            "Instructor Name", "Title or Rank", 
                            "Preferred Contact Method", "Email Address", "Phone Number",
                            "Office Address", "Office Hours", "Location (Physical or Remote)",
                            "Course SLOs", "Credit Hour Workload", "Assignments & Delivery",
                            "Grading Procedures & Final Grade Scale", "Assignment Deadlines & Policies"
                        ];

                        const minimumFields = [
                            "Course Number and Title", "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                            "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                            "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                            "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                            "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                            "Attendance", "Academic Integrity/Plagiarism/AI"
                        ];

                        const missingNECHE = requiredNECHEFields.filter(field => !reportData[field] || reportData[field] === "Not Found");
                        const missingMinimum = minimumFields.filter(field => !reportData[field] || reportData[field] === "Not Found");

                        const passFail = (missingNECHE.length === 0 && missingMinimum.length === 0) ? "Pass" : "Fail";
                        const statusColor = passFail === "Pass" ? "green" : "red";

                        const row = document.createElement("tr");

                        const nameCell = document.createElement("td");
                        nameCell.style.padding = "10px";
                        nameCell.style.border = "1px solid #ddd";
                        nameCell.innerHTML = `<strong>${filename}</strong>`;
                        row.appendChild(nameCell);

                        const statusCell = document.createElement("td");
                        statusCell.style.padding = "10px";
                        statusCell.style.textAlign = "center";
                        statusCell.style.border = "1px solid #ddd";
                        statusCell.innerHTML = `<strong style="color: ${statusColor};">${passFail}</strong>`;
                        row.appendChild(statusCell);

                        const buttonCell = document.createElement("td");
                        buttonCell.style.padding = "10px";
                        buttonCell.style.textAlign = "center";
                        buttonCell.style.border = "1px solid #ddd";

                        const viewBtn = createStyledButton("View", "modern-btn", () => showReportModal(reportData, filename));
                        const summaryBtn = createStyledButton("Summary", "modern-btn", () => showCompliancePopupClean(reportData, filename, result.compliance_check));
                        const shareBtn = createStyledButton("Share", "modern-btn", () => openEmailModal(filename));

                        viewBtn.style.marginRight = "8px";
                        summaryBtn.style.marginRight = "8px";
                        shareBtn.style.marginRight = "8px";

                        buttonCell.appendChild(viewBtn);
                        buttonCell.appendChild(summaryBtn);
                        buttonCell.appendChild(shareBtn);
                        row.appendChild(buttonCell);

                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    scrollWrapper.appendChild(table);

                    chatHistory.appendChild(scrollWrapper);

                    if (allResults.length > 1) {
                        const allBtnWrapper = document.createElement("div");
                        allBtnWrapper.style.textAlign = "center";
                        allBtnWrapper.style.marginTop = "20px";

                        const allReportsBtn = createStyledButton("Download All Reports", "modern-btn", () => downloadAllReports(allResults));
                        allBtnWrapper.appendChild(allReportsBtn);
                        chatHistory.appendChild(allBtnWrapper);
                    }

                    addHTMLMessage(`Successfully processed ${allResults.length} file(s)`, false);
                    reportButtons.style.display = "block";
                })
                .catch(error => {
                    addHTMLMessage(`⚠️ Error: ${error.message}`, false);
                    console.error("Upload error:", error);
                });
            }

            function createStyledButton(text, classes, clickHandler) {
                const button = document.createElement("button");
                button.textContent = text;
                button.className = `${classes}`;
                button.style.margin = "10px";
                button.addEventListener("click", clickHandler);
                return button;
            }

            function openEmailModal(filename) {
    const modal = new bootstrap.Modal(document.getElementById("emailModal"));
    document.getElementById("email-subject").value = `NECHE Compliance Report for ${filename}`;
    document.getElementById("email-body").value = `Attached is the NECHE compliance report for ${filename}.`;
    modal.show();

    document.getElementById("send-email-btn").onclick = () => {
        const to = document.getElementById("email-to").value;
        const subject = document.getElementById("email-subject").value;
        const body = document.getElementById("email-body").value;

        if (!to) {
            alert("Please enter a recipient email address.");
            return;
        }

        fetch("/send_email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filename, to, subject, body }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addHTMLMessage(data.message, false);
            } else {
                addHTMLMessage(`⚠️ Error: ${data.error}`, false);
            }
            modal.hide();
        })
        .catch(() => {
            addHTMLMessage("⚠️ Error: Failed to send email.", false);
            modal.hide();
        });
    };
}

            function downloadSingleReport(data, filename) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const requiredFields = [
                    "Instructor Name", "Title or Rank", "Preferred Contact Method",
                    "Email Address", "Phone Number", "Office Address", "Office Hours", "Location (Physical or Remote)",
                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery", "Grading Procedures & Final Grade Scale",
                    "Assignment Deadlines & Policies"
                ];

                const minimumFields = [
                    "Course Number and Title", "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                    "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                    "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                    "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                    "Attendance", "Academic Integrity/Plagiarism/AI"
                ];

                const optionalFields = [
                    "Course Prerequisites", "Simultaneous 700/800 Course Designation", "University Requirements",
                    "Teaching Assistants (Names and Contact Information)"
                ];
                const allFields = [...requiredFields, ...minimumFields, ...optionalFields];

                let courseTitleRaw = data["Course Number and Title"] || "Not Found";
                let courseId = "";
                let courseName = courseTitleRaw;
                if (courseTitleRaw !== "Not Found") {
                    const parts = courseTitleRaw.split(" ");
                    if (parts.length >= 2 && /^[A-Z]{2,}\d{2,}/.test(parts[0] + parts[1])) {
                        courseId = parts[0] + " " + parts[1];
                        courseName = parts.slice(2).join(" ");
                    } else {
                        courseId = courseTitleRaw;
                    }
                }
                let semester = data["Semester/Term (and start/end dates)"] || "Not Found";
                if (semester !== "Not Found") {
                    semester = semester.split(" ")[0];
                }
                let instructor = data["Instructor Name"] || "Not Found";

                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 10;
                const maxWidth = pageWidth - 2 * margin;
                const title = "Syllabus Compliance Report";
                const splitTitle = doc.splitTextToSize(title, maxWidth);
                let yPosition = 15;
                splitTitle.forEach((line, index) => {
                    const textWidth = doc.getTextWidth(line);
                    const xPosition = (pageWidth - textWidth) / 2;
                    doc.text(line, xPosition, yPosition + (index * 8));
                });

                yPosition += splitTitle.length * 8 + 10;
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                let courseDetails = [];
                if (courseId !== "Not Found") {
                    courseDetails.push(`Course ID: ${courseId}`);
                }
                if (courseName !== "Not Found") {
                    courseDetails.push(`Course Name: ${courseName}`);
                }
                if (semester !== "Not Found") {
                    courseDetails.push(`Semester: ${semester}`);
                }
                if (instructor !== "Not Found") {
                    courseDetails.push(`Instructor Name: ${instructor}`);
                }

                if (courseDetails.length > 0) {
                    courseDetails.forEach((detail, index) => {
                        const textWidth = doc.getTextWidth(detail);
                        const xPosition = (pageWidth - textWidth) / 2;
                        doc.text(detail, xPosition, yPosition + (index * 6));
                    });
                    yPosition += courseDetails.length * 6 + 10;
                } else {
                    const noDetails = "No course details available";
                    const textWidth = doc.getTextWidth(noDetails);
                    const xPosition = (pageWidth - textWidth) / 2;
                    doc.text(noDetails, xPosition, yPosition);
                    yPosition += 10;
                }

                const tableColumn = ["Syllabus Items", "Syllabus Details"];
                const tableRows = [];

                allFields.forEach(field => {
                    const value = data[field] || "Not Found";
                    const isOptional = optionalFields.includes(field);
                    if (isOptional && value === "Not Found") return;

                    let displayField = field;
                    if (requiredFields.includes(field)) {
                        displayField = `**${field}**`;
                    } else if (optionalFields.includes(field)) {
                        displayField = `***${field}***`;
                    }

                    const displayValue = value === "Not Found" ? "Not Found" : value;
                    tableRows.push([displayField, displayValue]);
                });

                doc.autoTable({
                    startY: yPosition,
                    head: [tableColumn],
                    body: tableRows,
                    theme: "grid",
                    headStyles: {
                        fillColor: [0, 53, 145],
                        textColor: [255, 255, 255],
                        fontSize: 14,
                        font: "Segoe UI",
                        fontStyle: "bold",
                        cellPadding: 3,
                    },
                    styles: {
                        font: "Segoe UI",
                        fontSize: 14,
                        cellPadding: { top: 3, right: 3, bottom: 3, left: 3 },
                        lineColor: [221, 221, 221],
                        lineWidth: 0.3,
                    },
                    columnStyles: {
                        0: { fillColor: [245, 245, 245], cellWidth: 80 },
                        1: { fillColor: [255, 255, 255], cellWidth: 100 },
                    },
                    didParseCell: function (data) {
                        if (data.column.index === 0) {
                            let text = data.cell.text[0];
                            if (text.startsWith("***") && text.endsWith("***")) {
                                data.cell.text[0] = text.slice(3, -3);
                                data.cell.styles.fontStyle = "italic";
                            } else if (text.startsWith("**") && text.endsWith("**")) {
                                data.cell.text[0] = text.slice(2, -2);
                                data.cell.styles.fontStyle = "bold";
                            } else {
                                data.cell.styles.fontStyle = "normal";
                            }
                        }

                        if (data.column.index === 1 && data.cell.text[0] === "Not Found") {
                            data.cell.styles.textColor = [255, 0, 0];
                            data.cell.styles.fontStyle = "bold";
                        }
                    }
                });

                const pageHeight = doc.internal.pageSize.getHeight();
                doc.setFontSize(10);
                doc.text("Formatting:", 10, pageHeight - 30);
                doc.text("NECHE Compliance Requirements: Bold", 10, pageHeight - 25);
                doc.text("Minimum Syllabus Requirements: Unbold & Unitalic", 10, pageHeight - 20);
                doc.text("Optional Syllabus Requirements: Italic", 10, pageHeight - 15);

                doc.save(`${filename}_NECHE_Report.pdf`);
            }

            function generateReport(data, filename) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const requiredFields = [
                    "Instructor Name", "Title or Rank",  "Preferred Contact Method",
                    "Email Address", "Phone Number", "Office Address", "Office Hours", "Location (Physical or Remote)",
                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery", "Grading Procedures & Final Grade Scale",
                    "Assignment Deadlines & Policies"
                ];

                const minimumFields = [
                    "Course Number and Title", "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                    "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                    "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                    "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                    "Attendance", "Academic Integrity/Plagiarism/AI"
                ];

                const optionalFields = [
                    "Course Prerequisites", "Simultaneous 700/800 Course Designation", "University Requirements",
                    "Teaching Assistants (Names and Contact Information)"
                ];
                const allFields = [...requiredFields, ...minimumFields, ...optionalFields];
                const tableColumn = ["Syllabus Items", "Syllabus Details"];
                const tableRows = [];

                allFields.forEach(field => {
                    const value = data[field] || "Not Found";
                    const isOptional = optionalFields.includes(field);

                    if (isOptional && value === "Not Found") return;

                    let displayField = field;
                    if (requiredFields.includes(field)) {
                        displayField = `**${field}**`;
                    } else if (optionalFields.includes(field)) {
                        displayField = `***${field}***`;
                    }

                    const displayValue = value === "Not Found" ? "Not Found" : value;
                    tableRows.push([displayField, displayValue]);
                });

                let title = "Syllabus Compliance Report";
                const course = data["Course Number and Title"];
                const professor = data["Instructor Name"];

                const headingParts = [];
                if (course && course !== "Not Found") headingParts.push(course);
                if (professor && professor !== "Not Found") headingParts.push(`by Professor ${professor}`);

                if (headingParts.length > 0) title += " – " + headingParts.join(" ");

                doc.setFontSize(12);
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 10;
                const maxWidth = pageWidth - 2 * margin;
                const splitTitle = doc.splitTextToSize(title, maxWidth);

                let yPosition = 15;
                splitTitle.forEach((line, index) => {
                    const textWidth = doc.getTextWidth(line);
                    const xPosition = (pageWidth - textWidth) / 2;
                    doc.text(line, xPosition, yPosition + (index * 5));
                });

                const titleHeight = splitTitle.length * 5;
                const tableStartY = yPosition + titleHeight + 5;

                doc.autoTable({
                    startY: tableStartY,
                    head: [tableColumn],
                    body: tableRows,
                    theme: "grid",
                    headStyles: {
                        fillColor: [0, 53, 145],
                        textColor: [255, 255, 255],
                        fontSize: 10,
                    },
                    styles: {
                        fontSize: 10,
                        cellPadding: 4,
                    },
                    columnStyles: {
                        0: { fillColor: [245, 245, 245] },
                        1: { fillColor: [255, 255, 255] },
                    },
                    didParseCell: function (data) {
                        if (data.column.index === 0) {
                            let text = data.cell.text[0];
                            if (text.startsWith("***") && text.endsWith("***")) {
                                data.cell.text[0] = text.slice(3, -3);
                                data.cell.styles.fontStyle = "italic";
                            } else if (text.startsWith("**") && text.endsWith("**")) {
                                data.cell.text[0] = text.slice(2, -2);
                                data.cell.styles.fontStyle = "bold";
                            } else {
                                data.cell.styles.fontStyle = "normal";
                            }
                        }

                        if (data.column.index === 1 && data.cell.text[0] === "Not Found") {
                            data.cell.styles.textColor = [255, 0, 0];
                            data.cell.styles.fontStyle = "bold";
                        }
                    }
                });

                doc.save(`${filename}_NECHE_Report.pdf`);
            }

            function showReportModal(data, filename) {
                const requiredFields = [
                    "Instructor Name", "Title or Rank",  "Preferred Contact Method",
                    "Email Address", "Phone Number", "Office Address", "Office Hours", "Location (Physical or Remote)",
                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery", "Grading Procedures & Final Grade Scale",
                    "Assignment Deadlines & Policies"
                ];

                const minimumFields = [
                    "Course Number and Title", "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                    "Modality/Meeting Time and Place", "Semester/Term (and start/end dates)", "Department/Program",
                    "Format (e.g., lecture plus lab/discussion etc.)", "Course Description (minimum course catalog description)",
                    "Sequence of Course Topics and Important Dates", "Required/Recommended Textbook (or other source for course reference information)",
                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)", "Technical Requirements",
                    "Attendance", "Academic Integrity/Plagiarism/AI"
                ];

                const optionalFields = [
                    "Course Prerequisites", "Simultaneous 700/800 Course Designation", "University Requirements",
                    "Teaching Assistants (Names and Contact Information)"
                ];
                const allFields = [...requiredFields, ...minimumFields, ...optionalFields];

                let html = `<html><head>
                    <title>NECHE Report - ${filename}</title>
                    <style>
                        body { 
                            font-family: "Segoe UI", sans-serif; 
                            padding: 20px; 
                            background: #f9f9fb; 
                            color: #333; 
                            max-width: 1000px; 
                            margin: auto; 
                        }
                        h1 { 
                            font-size: 24px; 
                            text-align: center; 
                            margin-bottom: 15px; 
                            font-weight: 600; 
                            color: #2a2a2a; 
                        }
                        .course-details-container { 
                            display: flex; 
                            flex-direction: column; 
                            align-items: center; 
                            margin-bottom: 20px; 
                            width: 100%; 
                        }
                        .course-details { 
                            display: flex; 
                            flex-direction: column; 
                            align-items: center; 
                            font-size: 14px; 
                            color: #333; 
                            width: 100%; 
                            max-width: 600px; 
                        }
                        .course-details p { 
                            display: flex; 
                            justify-content: space-between; 
                            width: 100%; 
                            margin: 5px 0; 
                            padding: 0 20px; 
                            text-align: left; 
                        }
                        .course-details p span.label { 
                            flex: 1; 
                            font-weight: bold; 
                            text-align: right; 
                            padding-right: 10px; 
                        }
                        .course-details p span.separator { 
                            flex: 0 0 20px; 
                            text-align: center; 
                        }
                        .course-details p span.value { 
                            flex: 1; 
                            text-align: left; 
                            padding-left: 10px; 
                        }
                        .download-btn { 
                            background-color: #003591; 
                            color: white; 
                            padding: 10px 20px; 
                            border-radius: 6px; 
                            border: none; 
                            cursor: pointer; 
                            font-size: 14px; 
                            transition: 0.3s ease; 
                            margin: 10px 20px 0 0; 
                            align-self: flex-end; 
                        }
                        .download-btn:hover { 
                            background-color: #001f5c; 
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            border: 1px solid #ccc; 
                            font-size: 14px; 
                        }
                        th, td { 
                            padding: 12px; 
                            border: 1px solid #ddd; 
                            vertical-align: top; 
                            text-align: left; 
                        }
                        th { 
                            background-color: #003591; 
                            color: white; 
                            font-weight: 600; 
                        }
                        td:first-child { 
                            background-color: #f5f5f5; 
                            width: 40%; 
                        }
                        td:last-child { 
                            background-color: #ffffff; 
                            width: 60%; 
                        }
                        .table-container { 
                            margin-top: 20px; 
                        }
                        .footer { 
                            margin-top: 20px; 
                            font-size: 14px; 
                            color: #555; 
                            text-align: center; 
                            border-top: 1px solid #ddd; 
                            padding-top: 10px; 
                        }
                    </style>
                </head><body>`;

                let courseTitleRaw = data["Course Number and Title"] || "Not Found";
                let courseId = "";
                let courseName = courseTitleRaw;
                if (courseTitleRaw !== "Not Found") {
                    const parts = courseTitleRaw.split(" ");
                    if (parts.length >= 2 && /^[A-Z]{2,}\d{2,}/.test(parts[0] + parts[1])) {
                        courseId = parts[0] + " " + parts[1];
                        courseName = parts.slice(2).join(" ");
                    } else {
                        courseId = courseTitleRaw;
                    }
                }
                let semester = data["Semester/Term (and start/end dates)"] || "Not Found";
                if (semester !== "Not Found") {
                    semester = semester.split(" ")[0];
                }
                let instructor = data["Instructor Name"] || "Not Found";

                let courseDetails = [];
                if (courseId !== "Not Found") {
                    courseDetails.push(`<p><span class="label">Course ID:</span><span class="separator">:</span><span class="value">${courseId}</span></p>`);
                }
                if (courseName !== "Not Found") {
                    courseDetails.push(`<p><span class="label">Course Name:</span><span class="separator">:</span><span class="value">${courseName}</span></p>`);
                }
                if (semester !== "Not Found") {
                    courseDetails.push(`<p><span class="label">Semester:</span><span class="separator">:</span><span class="value">${semester}</span></p>`);
                }
                if (instructor !== "Not Found") {
                    courseDetails.push(`<p><span class="label">Instructor Name:</span><span class="separator">:</span><span class="value">${instructor}</span></p>`);
                }

                html += `
                    <div class="course-details-container">
                        <h1>Syllabus Compliance Report</h1>
                        <div class="course-details">
                            ${courseDetails.length > 0 ? courseDetails.join("") : "<p>No course details available</p>"}
                        </div>
                        <button class="download-btn" onclick="downloadSingleReport(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(data))}')), '${filename}')">Download PDF</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Syllabus Items</th>
                                    <th>Syllabus Details</th>
                                </tr>
                            </thead>
                            <tbody>`;

                allFields.forEach((field) => {
                    const value = data[field] || "Not Found";
                    const isOptional = optionalFields.includes(field);

                    if (isOptional && value === "Not Found") return;

                    let formattedField = field;
                    if (requiredFields.includes(field)) {
                        formattedField = `<strong>${field}</strong>`;
                    } else if (optionalFields.includes(field)) {
                        formattedField = `<em>${field}</em>`;
                    }

                    const displayValue = value === "Not Found" ? `<span style="color: red; font-weight: bold;">Not Found</span>` : value.replace(/\n/g, "<br>");

                    html += `<tr><td>${formattedField}</td><td>${displayValue}</td></tr>`;
                });

                html += `</tbody></table></div>`;
                html += `
                    <div class="footer">
                        <strong>Formatting:</strong><br>
                        NECHE Compliance Requirements: <strong>Bold</strong><br>
                        Minimum Syllabus Requirements: Unbold & Unitalic<br>
                        Optional Syllabus Requirements: <em>Italic</em>
                    </div>
                </body></html>`;

                const newWin = window.open("", "_blank");
                newWin.document.open();
                newWin.document.write(html);
                newWin.downloadSingleReport = downloadSingleReport;
                newWin.document.close();
            }

            function downloadAllReports(results) {
                function loadScript(src, callback) {
                    const script = document.createElement("script");
                    script.src = src;
                    script.onload = callback;
                    script.onerror = () => {
                        console.error(`Failed to load script: ${src}`);
                        alert(`⚠️ Error: Failed to load required library: ${src}`);
                    };
                    document.head.appendChild(script);
                }

                if (!window.jspdf) {
                    console.warn("jsPDF is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js", () => {
                        console.log("jsPDF loaded successfully.");
                        if (!window.jspdfAutoTable) {
                            console.warn("jsPDF-AutoTable is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js", () => {
                                console.log("jsPDF-AutoTable loaded successfully.");
                                if (!window.JSZip) {
                                    console.warn("JSZip is not loaded. Loading it now...");
                                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                                        console.log("JSZip loaded successfully.");
                                        generateAllReports(results);
                                    });
                                } else {
                                    generateAllReports(results);
                                }
                            });
                        } else if (!window.JSZip) {
                            console.warn("JSZip is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                                console.log("JSZip loaded successfully.");
                                generateAllReports(results);
                            });
                        } else {
                            generateAllReports(results);
                        }
                    });
                } else if (!window.jspdfAutoTable) {
                    console.warn("jsPDF-AutoTable is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js", () => {
                        console.log("jsPDF-AutoTable loaded successfully.");
                        if (!window.JSZip) {
                            console.warn("JSZip is not loaded. Loading it now...");
                            loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                                console.log("JSZip loaded successfully.");
                                generateAllReports(results);
                            });
                        } else {
                            generateAllReports(results);
                        }
                    });
                } else if (!window.JSZip) {
                    console.warn("JSZip is not loaded. Loading it now...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js", () => {
                        console.log("JSZip loaded successfully.");
                        generateAllReports(results);
                    });
                } else {
                    generateAllReports(results);
                }

                function generateAllReports(results) {
                    const { jsPDF } = window.jspdf;
                    const zip = new JSZip();

                    if (!jsPDF || !JSZip) {
                        console.error("Required libraries (jsPDF or JSZip) are not loaded.");
                        alert("⚠️ Error: Required libraries not loaded.");
                        return;
                    }

                    results.forEach((result, index) => {
                        const doc = new jsPDF();
                        const filename = result.filename || `File_${index + 1}`;
                        const reportData = result.extracted_information || {};

                        const title = `Syllabus Compliance Report - ${filename}`;
                        doc.setFontSize(12);
                        doc.text(title, 10, 10);

                        const tableColumn = ["Syllabus Items", "Syllabus Details"];
                        const tableRows = [];

                        Object.keys(reportData).forEach((key) => {
                            const value = reportData[key] || "Not Found";
                            tableRows.push([key, value]);
                        });

                        doc.autoTable({
                            startY: 20,
                            head: [tableColumn],
                            body: tableRows,
                            theme: "grid",
                            headStyles: {
                                fillColor: [0, 53, 145],
                                textColor: [255, 255, 255],
                                fontSize: 10,
                            },
                            styles: {
                                fontSize: 10,
                                cellPadding: 4,
                            },
                        });

                        const pdfBlob = doc.output("blob");
                        zip.file(`${filename}_NECHE_Report.pdf`, pdfBlob);
                    });

                    zip.generateAsync({ type: "blob" }).then((content) => {
                        const zipBlob = new Blob([content], { type: "application/zip" });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(zipBlob);
                        link.download = "NECHE_Reports.zip";
                        link.click();
                    });
                }
            }

            function showCompliancePopupClean(data, filename, complianceStatus) {
                const requiredFields = [
                    "Instructor Name", "Title or Rank", 
                    "Preferred Contact Method", "Email Address", "Phone Number",
                    "Office Address", "Office Hours", "Location (Physical or Remote)",
                    "Course SLOs", "Credit Hour Workload", "Assignments & Delivery",
                    "Grading Procedures & Final Grade Scale", "Assignment Deadlines & Policies"
                ];

                const minimumFields = [
                    "Course Number and Title", "Number of Credits/Units (include a link to the federal definition of a credit hour)",
                    "Modality/Meeting Time and Place",
                    "Semester/Term (and start/end dates)",
                    "Department/Program",
                    "Format (e.g., lecture plus lab/discussion etc.)",
                    "Course Description (minimum course catalog description)",
                    "Sequence of Course Topics and Important Dates",
                    "Required/Recommended Textbook (or other source for course reference information)",
                    "Other Required/Recommended Materials (e.g., software, clicker remote, etc.)",
                    "Technical Requirements",
                    "Attendance",
                    "Academic Integrity/Plagiarism/AI"
                ];

                const missingNECHE = requiredFields.filter(field => data[field] === "Not Found" || !data[field]);
                const missingMinimum = minimumFields.filter(field => data[field] === "Not Found" || !data[field]);

                const courseRaw = data["Course Number and Title"] || "Not Found";
                const professor = data["Instructor Name"] || "Not Found";

                let courseNumber = "";
                let courseTitle = courseRaw;
                const parts = courseRaw.split(" ");
                if (parts.length >= 2 && /^[A-Z]{2,}\d{2,}/.test(parts[0] + parts[1])) {
                    courseNumber = parts[0] + " " + parts[1];
                    courseTitle = parts.slice(2).join(" ");
                }

                const isCompliant = missingNECHE.length === 0 && missingMinimum.length === 0;
                const statusColor = isCompliant ? "green" : "red";
                const statusText = isCompliant ? "Pass" : "Fail";

                const popupOverlay = document.createElement("div");
                popupOverlay.id = "compliance-popup";
                popupOverlay.style.position = "fixed";
                popupOverlay.style.top = "0";
                popupOverlay.style.left = "0";
                popupOverlay.style.width = "100vw";
                popupOverlay.style.height = "100vh";
                popupOverlay.style.backgroundColor = "rgba(0,0,0,0.5)";
                popupOverlay.style.display = "flex";
                popupOverlay.style.justifyContent = "center";
                popupOverlay.style.alignItems = "center";
                popupOverlay.style.zIndex = "9999";

                const popup = document.createElement("div");
                popup.style.background = "#ffffff";
                popup.style.borderRadius = "10px";
                popup.style.padding = "25px";
                popup.style.width = "90%";
                popup.style.maxWidth = "650px";
                popup.style.maxHeight = "85vh";
                popup.style.overflowY = "auto";
                popup.style.fontFamily = "Segoe UI, sans-serif";
                popup.style.boxShadow = "0 10px 30px rgba(0,0,0,0.3)";
                popup.style.color = "#000000";

                let popupContent = `
                    <div style="background-color: var(--unh-blue); color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 18px; border-top-left-radius: 10px; border-top-right-radius: 10px;">
                        Status
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Course Number</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${courseNumber ? courseNumber : "N/A"}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Course Title</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${courseTitle !== "Not Found" ? courseTitle : "N/A"}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Professor</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${professor !== "Not Found" ? professor : "N/A"}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; font-weight: bold; border: 1px solid #ddd;">Compliance Status</td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${statusText}</td>
                        </tr>
                    </table>
                    <div style="font-weight: bold; color: ${statusColor}; margin-bottom: 20px; text-align: center;">
                        The compliance check is complete. The syllabus is ${isCompliant ? "NECHE compliant." : "not NECHE compliant.<br>Here is the missing information."}
                    </div>`;

                if (missingNECHE.length > 0) {
                    popupContent += `
                        <div style="margin-top: 10px; text-align: left;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: var(--unh-blue); color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Missing NECHE Requirements</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${missingNECHE.map(field => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${field}</td>
                                        </tr>`).join("")}
                                </tbody>
                            </table>
                        </div>`;
                }

                if (missingMinimum.length > 0) {
                    popupContent += `
                        <div style="margin-top: 20px; text-align: left;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: var(--unh-blue); color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Missing Minimum Requirements</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${missingMinimum.map(field => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${field}</td>
                                        </tr>`).join("")}
                                </tbody>
                            </table>
                        </div>`;
                }

                popupContent += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="closeCompliancePopup" style="background-color: #000000; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>`;

                popup.innerHTML = popupContent;
                popupOverlay.appendChild(popup);
                document.body.appendChild(popupOverlay);

                document.getElementById("closeCompliancePopup").addEventListener("click", () => {
                    popupOverlay.remove();
                });
            }

            viewReportBtn.addEventListener("click", () => {
                if (latestReportData) {
                    showReportModal(latestReportData, "Latest_Upload");
                } else {
                    addHTMLMessage("No report available to view.", false);
                }
            });

            downloadReportBtn.addEventListener("click", () => {
                if (latestReportData) {
                    downloadSingleReport(latestReportData, "Latest_Upload");
                } else {
                    addHTMLMessage("No report available to download.", false);
                }
            });

            viewReport.addEventListener("click", () => {
                if (latestReportData) {
                    showReportModal(latestReportData, "Latest_Upload");
                } else {
                    addHTMLMessage("No report available to view.", false);
                }
            });

            downloadReport.addEventListener("click", () => {
                if (latestReportData) {
                    downloadSingleReport(latestReportData, "Latest_Upload");
                } else {
                    addHTMLMessage("No report available to download.", false);
                }
            });
        });
    </script>
</body>
</html>