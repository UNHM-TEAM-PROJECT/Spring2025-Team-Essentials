<!--
File: chatbot.py
Authors: 
Contributors: 
Date: 
-->

<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NECHE Compliance Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Global variables for consistent styling throughout the application */
        :root {
            --unh-blue: #3a17d8;
            --unh-white: #ffffff;
            --chat-bg: rgba(248, 249, 250, 0.95);
            --message-bg: rgba(233, 236, 239, 0.9);
            --input-bg: rgba(248, 249, 250, 0.95);
            --btn-color: #ebf0f9;
            --btn-hover: #9662be;
            --btn-text: #ffffff;
            --border-radius: 0;
            --unh-black: #403a3a;
        }
        /* Ensure the application occupies the full viewport with no extra margins or scrollbars */

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            background-image: url('../templates/chatbot-bg.png');
            background-size: 600px; /* Adjust the image size */
            background-repeat: no-repeat;
            background-position: center center;
        }


        body {
            background-image: url('../templates/chatbot-bg.png');
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        /* A transparent overlay to darken the background image and blur it slightly for readability */

        .page-container {
            height: 100vh;
            width: 100vw;
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.3);
        }
        /* Main chat container with full height and blurred background */

        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            margin: 0;
        }
            /* Chat header with a blue gradient background and centered content */

        .chat-header {
            background: linear-gradient(135deg, var(--unh-blue) 0%, #2a05cf 100%);
            color: var(--unh-white);
            padding: 1rem;
            display: flex;
            justify-content: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            height: 80px;
        }

        /* Flex container for header logo and title */
        .header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Logo styling */
        .chat-header img {
            height: 60px;
            width: auto;
            object-fit: contain;
        }
        
        /* Header title styling */
        .chat-header-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
         /* Message container with scrolling and background styling */

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: transparent;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)),
                url('/Users/bubby/TeamGulliver/static/logo.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Container for edit icon positioned at bottom-right */

       .edit-icon-container {
            position: absolute; /* Position it absolutely within the message container */
            bottom: 40px; /* Place it at the bottom */
            right: -2px; /* Align it to the right */
            z-index: 1; /* Ensure it appears above content */
            display: flex;
            align-items: center;
            justify-content: center;
        }
         /* Styling for clickable edit icon */

        .edit-icon {
            font-size: 16px; /* Adjust size */
            color: var(--unh-black); /* Default color for the edit icon */
            cursor: pointer; /* Make it clickable */
            transition: color 0.2s ease-in-out; /* Smooth hover effect */
        }
        
        /* Hover effect for the edit icon */
        .edit-icon:hover {
            color: var(--unh-blue); /* Highlight color on hover */
        }
        
        /* Chat message styling with animation and shadows */
        .message {
            position: relative;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 1rem;
            max-width: 75%;
            animation: fadeIn 0.3s ease-in-out;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }
        
        /* Fade-in animation for new messages */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styling for user messages aligned to the right */
        .user-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
            text-align: left;
        }
        
         /* Styling for assistant messages aligned to the left */
        .assistant-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            backdrop-filter: blur(5px);
            text-align: left;
        }
        
        /* Small circular avatar next to messages */
        .message-avatar {
            width: 32px;
            height: 32px;
            position: absolute;
            bottom: -16px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
        /* Container for the input and buttons */
        .message-content {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Push buttons to the right */
            gap: 10px; /* Spacing between elements */
        }
        
        /* Style for the input field */
        .edit-input {
            flex-grow: 1; /* Make input take available space */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        /* Action buttons (Cancel and Send) */
        .action-buttons {
            display: flex;
            gap: 8px; /* Space between buttons */
        }
        
        .cancel-button,
        .send-button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1.2;
        }
        
        .cancel-button {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .send-button {
            background-color: #002B7D; /* Updated color */
            color: #fff; /* Keep the text white for contrast */
        }
        
        /* Optional hover effect */
        .send-button:hover {
            background-color: #001F5C; /* A slightly darker shade for hover */
        }
        
        
        /* Hover effects for buttons */
        .cancel-button:hover {
            background-color: #e0e0e0;
        }

        /* Avatar for user messages, positioned to the right and styled with blue background and white icon color */
        .user-message .message-avatar {
            right: -16px;
            background-color: var(--unh-blue);
            color: white;
        }
        
        /* Avatar for assistant messages, positioned to the left and styled with blue background and white icon color */
        .assistant-message .message-avatar {
            left: -16px;
            background-color: var(--unh-blue);
            color: white;
        }
        
        /* Container for the input field and send button, centered horizontally with rounded bottom corners */
        .input-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background-color: #e6e6fa;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }
        
        /* Group for input field and send button, styled with rounded corners and shadow */
        .input-group {
            background-color: var(--unh-white);
            border-radius: 2rem;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Text input field styling, with padding and transparent background */
        #user-input {
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background: transparent;
        }

        /* Remove shadow on focus for a cleaner look */
        #user-input:focus {
            box-shadow: none;
        }
        
        /* Send button styling, circular with blue background, centered icon, and hover effect */
        #send-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #0b5ed7; 
            color: var(--btn-text);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }
        #uploadButton {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #0b5ed7; 
            color: var(--btn-text);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }
        
        /* Hover effect for send button with slight scale animation */
        #send-button:hover {
            background-color: #0b5ed7;
            transform: scale(1.05);
        }

        /* Edit button styling, positioned at the top-right of its container with a semi-transparent background */
        .edit-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--unh-black);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Hover effect for edit button with increased background opacity */
        .edit-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Custom Scrollbar */
        .chat-history::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(0, 53, 145, 0.5);
            border-radius: 4px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 53, 145, 0.7);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            font-size: 1rem;
            color: #666;
            margin-top: 10px;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            margin: 0 2px;
            animation: blink 1s infinite alternate;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                border-radius: 0;
            }

            .message {
                max-width: 85%;
            }

            .chat-header {
                padding: 0.75rem;
                height: 70px;
            }

            .chat-header img {
                height: 60px;
            }

            .chat-header-title {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="container-fluid h-100 p-0">
            <div class="row h-100 m-0">
                <div class="col-12 p-0">
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="header-content">
                                <h1 class="chat-header-title">NECHE Syllabus Assistant
 </h1>
                            <!-- Additional Logo -->
                        </div>
                    </div>
                    
                        <div class="chat-history" id="chat-history">
                            <!-- Chat messages will be inserted here -->
                        </div>
                        <div class="input-area">
                            <div class="input-group">
                                <button id="uploadButton" class="plus-icon">+</button>
                                <input type="file" id="fileInput" accept=".pdf, .docx" style="display: none;">
                                <input type="text" id="user-input" class="form-control" placeholder="Type your text here...">
                                <button id="send-button" class="btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 style="text-align: center; font-weight: bold; margin-bottom: 20px;">NECHE Requirement List</h2>

    <table style="width: 100%; border-collapse: collapse; font-size: 16px; text-align: left; background: white; box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden;">
        <thead>
            <tr style="background-color: #3a17d8; color: white; text-align: center;">
                <th style="padding: 15px; border: 1px solid #ddd; width: 40%;">Requirement</th>
                <th style="padding: 15px; border: 1px solid #ddd; width: 60%;">Details</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Instructor Name</td>
                <td style="padding: 14px; border: 1px solid #ddd;">Phillip Deen</td>
            </tr>
            
            <tr style="background-color: #f9f9f9;">
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Title or Rank</td>
                <td style="padding: 14px; border: 1px solid #ddd;">Senior Lecturer of Philosophy & Humanities</td>
            </tr>
    
            <tr>
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Department or Program Affiliation</td>
                <td style="padding: 14px; border: 1px solid #ddd; color: red; font-weight: bold;">Not Found</td>
            </tr>
    
            <tr style="background-color: #f9f9f9;">
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Preferred Contact Method</td>
                <td style="padding: 14px; border: 1px solid #ddd;">E-mail</td>
            </tr>
    
            <tr>
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Professor's Email Address</td>
                <td style="padding: 14px; border: 1px solid #ddd;">phillip.deen@unh.edu</td>
            </tr>
    
            <tr style="background-color: #f9f9f9;">
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Professor's Phone Number</td>
                <td style="padding: 14px; border: 1px solid #ddd; color: red; font-weight: bold;">Not Found</td>
            </tr>
    
            <tr>
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Office Address</td>
                <td style="padding: 14px; border: 1px solid #ddd;">431</td>
            </tr>
    
            <tr style="background-color: #f9f9f9;">
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Office Hours</td>
                <td style="padding: 14px; border: 1px solid #ddd;">Tuesdays and Thursdays before 10:00 or after class at 3:00</td>
            </tr>
    
            <tr>
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Location (Physical or Remote)</td>
                <td style="padding: 14px; border: 1px solid #ddd;">Classroom 345</td>
            </tr>
    
            <tr style="background-color: #f9f9f9;">
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Course Learning Outcomes</td>
                <td style="padding: 14px; border: 1px solid #ddd;">
                    Gain knowledge about the texts and culture of classical Greece, engage deeply with 
                    general questions of aesthetics, politics, metaphysics, and the nature of a good life, 
                    learn how to read and think critically.
                </td>
            </tr>
    
            <tr>
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Credit Hour Workload</td>
                <td style="padding: 14px; border: 1px solid #ddd; color: red; font-weight: bold;">Not Found</td>
            </tr>
    
            <tr style="background-color: #f9f9f9;">
                <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">Grading Procedures & Final Grade Scale</td>
                <td style="padding: 14px; border: 1px solid #ddd;">
                    A: 93.3+, A-: 90.0-93.2, B+: 86.6-89.9, B: 83.3-86.5, B-: 80.0-83.2, 
                    C+: 76.6-79.9, C: 73.3-76.5, C-: 70.0-73.2, D+: 66.6-69.9, 
                    D: 63.3-66.5, D-: 60.0-63.2, F: 0-59.9
                </td>
            </tr>
        </tbody>
    </table>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chatHistory = document.getElementById("chat-history");
            const userInput = document.getElementById("user-input");
            const sendButton = document.getElementById("send-button");
            const fileInput = document.getElementById("fileInput");
            const uploadButton = document.getElementById("uploadButton");
        
            // ✅ Display Welcome Message
            function displayWelcomeMessage() {
                addHTMLMessage("Welcome! I can assist with NECHE compliance. How can I help you today?", false);
            }
            window.addEventListener("load", displayWelcomeMessage);
        
            // ✅ Function to Add Messages
            function addHTMLMessage(htmlContent, isUser) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", isUser ? "user-message" : "assistant-message");
        
                const messageContent = document.createElement("div");
                messageContent.classList.add("message-content");
                messageContent.innerHTML = htmlContent;
                messageDiv.appendChild(messageContent);
        
                const avatar = document.createElement("div");
                avatar.classList.add("message-avatar");
                avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
                messageDiv.appendChild(avatar);
        
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        
            // ✅ Handle Enter Key & Send Button Click
            sendButton.addEventListener("click", handleSend);
            userInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    handleSend();
                }
            });
        
            function handleSend() {
                const message = userInput.value.trim();
                if (!message) return;
        
                addHTMLMessage(message, true);
                userInput.value = "";
        
                addTypingIndicator();
        
                fetch("/ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message }),
                })
                .then(response => response.json())
                .then(data => {
                    removeTypingIndicator();
                    addHTMLMessage(data.response, false);
                })
                .catch(error => {
                    removeTypingIndicator();
                    addHTMLMessage("⚠️ Error: Unable to communicate with the server.", false);
                });
            }
        
            // ✅ Upload File Handling
            uploadButton.addEventListener("click", function () {
                fileInput.click();
            });
        
            fileInput.addEventListener("change", function (e) {
                const file = e.target.files[0];
        
                if (file && (file.type === "application/pdf" || file.name.endsWith(".docx"))) {
                    addMessage(`File selected: ${file.name}`, true);
                    handleFileUpload(file);
                } else {
                    addMessage("The checker only supports PDF and DOCX files.", false);
                    fileInput.value = "";
                }
            });
        
            function handleFileUpload(file) {
                const formData = new FormData();
                formData.append("file", file);
        
                addMessage("Processing the uploaded syllabus for NECHE requirements...", false);
        
                fetch("/upload", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let extractedInfo = data.extracted_information || {};
        
                        const requiredOrder = [
                            "Instructor Name", "Title or Rank", "Department or Program Affiliation",
                            "Preferred Contact Method", "Email Address", "Phone Number",
                            "Office Address", "Office Hours", "Location (Physical or Remote)",
                            "Course Learning Outcomes", "Credit Hour Workload", "Coursework Types & Submission Methods",
                            "Grading Procedures & Final Grade Scale", "Assignment Deadlines & Policies"
                        ];
        
                        // ✅ Show NECHE Compliance Status First
                        let complianceMessage = data.compliance_check || "Compliance check could not be completed.";
                        let complianceDiv = `<div style="padding: 15px; border-radius: 5px; margin-top: 20px;
                            background-color: ${complianceMessage.includes("not compliant") ? "#ffcccc" : "#ccffcc"};
                            color: black; font-size: 16px; font-weight: bold;">
                            ${complianceMessage}
                        </div>`;
                        addHTMLMessage(complianceDiv, false);
        
                        // ✅ Display NECHE Requirements Table
                        let infoHTML = `
                            <table style="width: 100%; border-collapse: collapse; font-size: 16px; text-align: left; background: white; 
                                box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background-color: #3a17d8; color: white; text-align: center;">
                                        <th style="padding: 15px; border: 1px solid #ddd; width: 40%;">Requirement</th>
                                        <th style="padding: 15px; border: 1px solid #ddd; width: 60%;">Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
        
                        requiredOrder.forEach((key) => {
                            let value = extractedInfo[key] || "Not Found";
                            if (typeof value !== "string") value = String(value);
                            value = value.trim();
        
                            if (value === "Not Found") {
                                value = `<strong style="color: red;">${value}</strong>`;
                            }
        
                            infoHTML += `
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #ddd; font-weight: bold;">${key}</td>
                                    <td style="padding: 14px; border: 1px solid #ddd;">${value}</td>
                                </tr>
                            `;
                        });
        
                        infoHTML += `</tbody></table>`;
                        addHTMLMessage(infoHTML, false);
                    } else {
                        throw new Error(`❌ Upload failed: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error("❌ Error:", error.message);
                    addMessage(`⚠️ ${error.message}`, false);
                });
            }
        
            // ✅ Utility Functions
            function addMessage(content, isUser) {
                if (!content) return;
        
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", isUser ? "user-message" : "assistant-message");
        
                const messageContent = document.createElement("div");
                messageContent.classList.add("message-content");
        
                const textSpan = document.createElement("span");
                textSpan.textContent = content;
                messageContent.appendChild(textSpan);
        
                if (content.includes("The NECHE compliance check is complete")) {
                    messageDiv.style.backgroundColor = content.includes("not compliant") ? "#ffcccc" : "#ccffcc";
                    messageDiv.style.color = "#000000";
                }
        
                messageDiv.appendChild(messageContent);
        
                const avatar = document.createElement("div");
                avatar.classList.add("message-avatar");
                avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
                messageDiv.appendChild(avatar);
        
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        
            function addTypingIndicator() {
                const typingDiv = document.createElement("div");
                typingDiv.classList.add("typing-indicator");
                typingDiv.id = "typing-indicator";
        
                const typingText = document.createElement("span");
                typingText.textContent = "Typing...";
                typingDiv.appendChild(typingText);
        
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement("div");
                    dot.classList.add("dot");
                    typingDiv.appendChild(dot);
                }
        
                chatHistory.appendChild(typingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById("typing-indicator");
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
        });
        </script>
        
    
    
</body>
</html>